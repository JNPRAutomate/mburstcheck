version 1.0;ns junos = "http://xml.juniper.net/junos/*/junos";ns xnm = "http://xml.juniper.net/xnm/1.1/xnm";ns jcs = "http://xml.juniper.net/junos/commit-scripts/1.0";ns ext = "http://xmlsoft.org/XSLT/namespace";import "../import/junos.xsl";var  $connection = jcs:open();template rpfe-exe-np-cnt($np-id, $node, $fpc) {  var $rpc = {    <rpc> {      <request-pfe-execute> {        <target> "tnp";        <command> "show np " _ $np-id _ " counters debug";        <tnp-name> "node" _ $node _ ".fpc" _ $fpc;        /*<tnp-name> "fpc" _ $fpc;*/      }    }  }  var $results = jcs:execute($connection,$rpc);  var $lines = jcs:break-lines($results);  var $np-ingress-line = 14;  var $np-egress-line = 20;  for-each($lines) {      var $sane = jcs:regex("^(GOT: Dropped packets:)(.*)",.);      if ($sane[3] != "") {        var $stats-counter = normalize-space($sane[3]);    <np-stats> {        <node> $node;        <fpc> $fpc;        <np> $np-id;        <value> $stats-counter;        if (position() == $np-ingress-line) {          <direction> "Ingress";          expr jcs:output( jcs:printf("%4d %4d %4d %10s %10d", $node, $fpc, $np-id, "Ingress", $stats-counter) );        } else if (position() == $np-egress-line) {          <direction> "Egress";          expr jcs:output( jcs:printf("%4d %4d %4d %10s %10d", $node, $fpc, $np-id, "Egress", $stats-counter) );        }      }    }  }}template get-ioc-info () {  /* loop and return all of the FPC numbers */  var $cgioc = "SRX5K-4XGE-XFP-A"; /* grab string to match for correct IOC type */  /* grab info and stats for IOCs on node0 */  var $rpc = {    <rpc> {      <command> {            expr "show chassis hardware node 0";      }    }  }  var $results = jcs:execute($connection,$rpc);  for-each($results//chassis/chassis-module) {    if (./model-number == $cgioc) {      /* get stats from each np */      var $fpc-id = jcs:regex("^(FPC )(.*)",./name);      var $np0-node0-results = {        call rpfe-exe-np-cnt() {          with $np-id = "0";          with $node = "0";          with $fpc = $fpc-id[3];        }      }      var $np1-node0-results = {        call rpfe-exe-np-cnt() {          with $np-id = "1";          with $node = "0";          with $fpc = $fpc-id[3];        }      }      var $np2-node0-results = {        call rpfe-exe-np-cnt() {          with $np-id = "2";          with $node = "0";          with $fpc = $fpc-id[3];        }      }      var $np3-node0-results = {        call rpfe-exe-np-cnt() {          with $np-id = "3";          with $node = "0";          with $fpc = $fpc-id[3];        }      }      copy-of $np0-node0-results;      copy-of $np1-node0-results;      copy-of $np2-node0-results;      copy-of $np3-node0-results;    } else {      /* specified card is not the one we are looking for */    }  }  /* grab info and stats for IOCs on node0 */  var $rpc2 = {    <rpc> {      <command> {            expr "show chassis hardware node 1";      }    }  }  var $results2 = jcs:execute($connection,$rpc2);  for-each($results//chassis/chassis-module) {    if (./model-number == $cgioc) {      /* get stats from each np */      var $fpc-id = jcs:regex("^(FPC )(.*)",./name);      var $np0-node1-results = {        call rpfe-exe-np-cnt() {          with $np-id = "0";          with $node = "1";          with $fpc = $fpc-id[3];        }      }      var $np1-node1-results = {        call rpfe-exe-np-cnt() {          with $np-id = "1";          with $node = "1";          with $fpc = $fpc-id[3];        }      }      var $np2-node1-results = {        call rpfe-exe-np-cnt() {          with $np-id = "2";          with $node = "1";          with $fpc = $fpc-id[3];        }      }      var $np3-node1-results = {        call rpfe-exe-np-cnt() {          with $np-id = "3";          with $node = "1";          with $fpc = $fpc-id[3];        }      }      copy-of $np0-node1-results;      copy-of $np1-node1-results;      copy-of $np2-node1-results;      copy-of $np3-node1-results;    } else {      /* specified card is not the one we are looking for */    }  }}template set-utility-mib() {}template write-to-file($string-content) {  <op-script-results> {    <xsl:document href="/var/tmp/output-file" append="yes" method="text"> {      <total-np-stats> {        expr $string-content;      }    }  }}match / {  if (not($connection)) {    call emit-error($message = "Not able to connect to local device");  }  /* expr jcs:output( jcs:printf("%s", "\nNPU packet drop monitoring script\n\n") ); */  expr jcs:output( jcs:printf("%4s %4s %4s %10s %10s", "\nNode", "FPC", "NPU", "Direction", "Drops") );  expr jcs:output( jcs:printf("%s", "-------------------------------------") );  var $str = {    call get-ioc-info();  }  <op-script-results> {    <xsl:document href="/var/tmp/output-file" append="no" method="xml"> {      <total-np-stats> {        copy-of $str;      }    }    <output> "\n\n Results written to disk /var/tmp/outputfile"; /* retsult output */  }}