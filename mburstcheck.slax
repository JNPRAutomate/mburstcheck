version 1.0;ns junos = "http://xml.juniper.net/junos/*/junos";ns xnm = "http://xml.juniper.net/xnm/1.1/xnm";ns jcs = "http://xml.juniper.net/junos/commit-scripts/1.0";ns ext = "http://xmlsoft.org/XSLT/namespace";ns bit extension = "http://xml.libslax.org/bit";import "../import/junos.xsl";var $connection = jcs:open();template get-ioc-info() {  expr jcs:output( jcs:printf("%s", "\nCG-IOC NPU Stats") );  expr jcs:output( jcs:printf("%4s %4s %4s %10s %10s", "Node", "FPC", "NPU", "Direction", "Drops") );  expr jcs:output( jcs:printf("%s", "-------------------------------------") );  /* loop and return all of the FPC numbers */  /* add additonal matching if needed */  var $cgioc = "SRX5K-4XGE-XFP-A"; /* CG IOC 4x10G */  /* grab info and stats for IOCs on node0 */  var $rpc = {    <rpc> {      <command> {        expr "show chassis hardware models node 0";      }    }  }  var $results = jcs:execute($connection,$rpc);  for-each($results//chassis/chassis-module) {    if (./model-number == $cgioc) {      /* get stats from each np */      var $fpc-id = jcs:regex("^(FPC )(.*)",./name);      var $np0-node0-results = {        call rpfe-exe-np-cnt-sp() {          with $np-id = "0";          with $node = "0";          with $fpc = $fpc-id[3];        }      }      var $np1-node0-results = {        call rpfe-exe-np-cnt-sp() {          with $np-id = "1";          with $node = "0";          with $fpc = $fpc-id[3];        }      }      var $np2-node0-results = {        call rpfe-exe-np-cnt-sp() {          with $np-id = "2";          with $node = "0";          with $fpc = $fpc-id[3];        }      }      var $np3-node0-results = {        call rpfe-exe-np-cnt-sp() {          with $np-id = "3";          with $node = "0";          with $fpc = $fpc-id[3];        }      }      copy-of $np0-node0-results;      copy-of $np1-node0-results;      copy-of $np2-node0-results;      copy-of $np3-node0-results;    } else {      /* specified card is not the one we are looking for */    }  }  /* grab info and stats for IOCs on node1 */  var $rpc2 = {    <rpc> {      <command> {            expr "show chassis hardware models node 1";      }    }  }  var $results2 = jcs:execute($connection,$rpc2);  for-each($results2//chassis/chassis-module) {    if (./model-number == $cgioc) {      /* get stats from each np */      var $fpc-id = jcs:regex("^(FPC )(.*)",./name);      var $np0-node1-results = {        call rpfe-exe-np-cnt-sp() {          with $np-id = "0";          with $node = "1";          with $fpc = $fpc-id[3];        }      }      var $np1-node1-results = {        call rpfe-exe-np-cnt-sp() {          with $np-id = "1";          with $node = "1";          with $fpc = $fpc-id[3];        }      }      var $np2-node1-results = {        call rpfe-exe-np-cnt-sp() {          with $np-id = "2";          with $node = "1";          with $fpc = $fpc-id[3];        }      }      var $np3-node1-results = {        call rpfe-exe-np-cnt-sp() {          with $np-id = "3";          with $node = "1";          with $fpc = $fpc-id[3];        }      }      copy-of $np0-node1-results;      copy-of $np1-node1-results;      copy-of $np2-node1-results;      copy-of $np3-node1-results;    } else {      /* specified card is not the one we are looking for */    }  }}template get-spc-info() {  expr jcs:output( jcs:printf("%s", "\nNG-SPC XM Stats") );  expr jcs:output( jcs:printf("%4s %4s %4s %10s %10s", "Node", "FPC", "XM", "Direction", "Drops") );  expr jcs:output( jcs:printf("%s", "-------------------------------------") );  var $ngspc = "SRX5K-SPC-4-15-320"; /* NGSPC model number */  var $rpc = {    <rpc> {      <command> {        expr "show chassis hardware models node 0";      }    }  }  var $results = jcs:execute($connection,$rpc);  for-each($results//chassis/chassis-module) {    if (./model-number == $ngspc) {      /* get stats from each xm */      var $fpc-id = jcs:regex("^(FPC )(.*)",./name);      var $xm0-node0-results = {        call rpfe-exe-mtip-cge() {          with $node = "0";          with $fpc = $fpc-id[3];        }      }      copy-of $xm0-node0-results;    }  }  var $rpc1 = {    <rpc> {      <command> {        expr "show chassis hardware models node 1";      }    }  }  var $results1 = jcs:execute($connection,$rpc1);  for-each($results1//chassis/chassis-module) {    if (./model-number == $ngspc) {      /* get stats from each xm */      var $fpc-id = jcs:regex("^(FPC )(.*)",./name);      var $xm0-node1-results = {        call rpfe-exe-mtip-cge() {          with $node = "1";          with $fpc = $fpc-id[3];        }      }      var $xm0-node1-ifd-results = {        call rpfe-exe-xm-ifd() {          with $node = "1";          with $fpc = $fpc-id[3];        }      }      copy-of $xm0-node1-results;    }  }}template get-spu-info() {  expr jcs:output( jcs:printf("%s", "\nNG-SPU Stats") );  expr jcs:output( jcs:printf("%4s %4s %4s %10s %10s", "Node", "FPC", "SPU", "Direction", "Drops") );  expr jcs:output( jcs:printf("%s", "-------------------------------------") );  var $ngspc = "SRX5K-SPC-4-15-320"; /* NGSPC model number */  var $rpc = {    <rpc> {      <command> {        expr "show chassis hardware models node 0";      }    }  }  var $results = jcs:execute($connection,$rpc);  for-each($results//chassis/chassis-module) {    if (./model-number == $ngspc) {      /* get stats from each spu */      var $fpc-id = jcs:regex("^(FPC )(.*)",./name);      var $spu0-node0-results = {        call rpfe-exe-xlp-nae() {          with $node = "0";          with $fpc = $fpc-id[3];          with $pic = "0";        }      }      var $spu1-node0-results = {        call rpfe-exe-xlp-nae() {          with $node = "0";          with $fpc = $fpc-id[3];          with $pic = "1";        }      }      var $spu2-node0-results = {        call rpfe-exe-xlp-nae() {          with $node = "0";          with $fpc = $fpc-id[3];          with $pic = "2";        }      }      var $spu3-node0-results = {        call rpfe-exe-xlp-nae() {          with $node = "0";          with $fpc = $fpc-id[3];          with $pic = "3";        }      }      copy-of $spu0-node0-results;      copy-of $spu1-node0-results;      copy-of $spu2-node0-results;      copy-of $spu3-node0-results;    }  }  var $rpc1 = {    <rpc> {      <command> {        expr "show chassis hardware models node 1";      }    }  }  var $results1 = jcs:execute($connection,$rpc1);  for-each($results1//chassis/chassis-module) {    if (./model-number == $ngspc) {      /* get stats from each spu */      var $fpc-id = jcs:regex("^(FPC )(.*)",./name);      var $spu0-node1-results = {        call rpfe-exe-xlp-nae() {          with $node = "1";          with $fpc = $fpc-id[3];          with $pic = "0";        }      }      var $spu1-node1-results = {        call rpfe-exe-xlp-nae() {          with $node = "1";          with $fpc = $fpc-id[3];          with $pic = "1";        }      }      var $spu2-node1-results = {        call rpfe-exe-xlp-nae() {          with $node = "1";          with $fpc = $fpc-id[3];          with $pic = "2";        }      }      var $spu3-node1-results = {        call rpfe-exe-xlp-nae() {          with $node = "1";          with $fpc = $fpc-id[3];          with $pic = "3";        }      }      copy-of $spu0-node1-results;      copy-of $spu1-node1-results;      copy-of $spu2-node1-results;      copy-of $spu3-node1-results;    }  }}template rpfe-exe-xm-ifd($node,$fpc) {  var $rpc = {    <rpc> {      <request-pfe-execute> {        <target> "tnp";        <command> "show xmchip 0 ifd list 1";        <tnp-name> "node" _ $node _ ".fpc" _ $fpc;      }    }  }  var $results = jcs:execute($connection,$rpc);  var $lines = jcs:break-lines($results);  for-each($lines) {    var $line = normalize-space(.);    var $sane = jcs:regex("GOT: \.spu([0-9]{1})\/([0-9]{1}) ([0-9]*) ([0-9]*) WAN ([0-9]*) ([0-9]*) ([0-9]*)",$line);    var $spuid = $sane[2];    var $spuchan = $sane[3];    var $queueid = $sane[7];    if ($spuchan == 0) {      /* Check q-node stats */      var $qnode = {        call rpfe-exe-xm-qns() {          with $node = $node;          with $fpc = $fpc;          with $queue = $queueid;        }      }      <qnode-stats> {        copy-of $qnode;      }      var $qstats = {        <qnode-stats> {          copy-of $qnode;        }      }      var $nodes = ext:node-set($qstats);      expr jcs:output( jcs:printf("%4d %4d %4d %10s %10d", $node, $fpc, "0", "Q-Node", sum($nodes//packets)));    }  }}template rpfe-exe-xm-qns($node,$fpc,$queue) {  var $rpc = {    <rpc> {      <request-pfe-execute> {        <target> "tnp";        <command> "show xmchip 0 q-node stats 0 " _ $queue;        <tnp-name> "node" _ $node _ ".fpc" _ $fpc;      }    }  }  var $results = jcs:execute($connection,$rpc);  var $lines = jcs:break-lines($results);  <qnode> {    for-each($lines) {      var $line = normalize-space(.);      var $sane = jcs:regex(" ([0-9]{1}) WRED drops ([0-9]*) Packets ([0-9]*) ([0-9]*) pps",$line);      if ($sane[2] != "") {        <node> $node;        <fpc>  $fpc;        <xmchip> "0";        <queue> $queue;        <color> $sane[2];        <packets> $sane[4];      }    }  }}template rpfe-exe-xlp-nae($node, $fpc, $pic) {  /* allow this to work in cluster and singularily */  var $rpc = {    <rpc> {      <request-pfe-execute> {        <target> "tnp";        <command> "show xlp nae xaui";        <tnp-name> "node" _ $node _ ".fpc" _ $fpc _ ".pic" _ $pic;      }    }  }  var $results = jcs:execute($connection,$rpc);  var $lines = jcs:break-lines($results);  for-each($lines) {    var $sane = jcs:regex("^(GOT: Tx Pause Frame:)(.*)",.);    if ($sane[3] != "") {      var $pause-counter = normalize-space($sane[3]);      expr jcs:output( jcs:printf("%4d %4d %4d %10s %10d", $node, $fpc, $pic, "XM to SPU", $pause-counter) );      <xlr-stats> {        <node> $node;        <fpc> $fpc;        <pic> $pic;        <value> $pause-counter;        <type> "pause-frames-xlp-nae";      }    }  }}template rpfe-exe-mtip-cge($node, $fpc) {  var $rpc = {    <request-pfe-execute> {      <target> "tnp";      <command> "show mtip-cge 2 statistics";      <tnp-name> "node" _ $node _ ".fpc" _ $fpc ;    }  }  var $results = jcs:execute($connection,$rpc);  var $lines = jcs:break-lines($results);  for-each($lines) {    var $sane = jcs:regex("^(GOT:   aPAUSEMACCtrlFramesReceived:)(.*)",.);    if ($sane[3] != "") {      var $pause-counter = normalize-space($sane[3]);      expr jcs:output( jcs:printf("%4d %4d %4d %10s %10d", $node, $fpc, "0", "SPU to XM", $pause-counter) );      <xm-stats> {        <node> $node;        <fpc> $fpc;        <value> $pause-counter;        <type> "pause-frames-mtip";      }    }  }}template rpfe-exe-np-cnt-sp($np-id, $node, $fpc) {  /* allow this to work in cluster and singularily */  var $rpc = {    <rpc> {      <request-pfe-execute> {        <target> "tnp";        <command> "show np " _ $np-id _ " counters special";        <tnp-name> "node" _ $node _ ".fpc" _ $fpc;        /*<tnp-name> "fpc" _ $fpc;*/      }    }  }  var $results = jcs:execute($connection,$rpc);  var $lines = jcs:break-lines($results);  /* using line location specify the ingress or egress */  for-each($lines) {      var $line = normalize-space(.);      var $sane = jcs:regex("GOT: EBDMA discard counter 0 .0x17ff80. : (.*)",$line);      if ($sane[2] != "") {        var $discard-counter = {          call convert-hex2dec(){            with $hex = normalize-space($sane[2]);          }        }        expr jcs:output( jcs:printf("%4d %4d %4d %10s %10d", $node, $fpc, $np-id, "Ingress", $discard-counter) );      <np-stats> {        <node> $node;        <fpc> $fpc;        <np> $np-id;        <type> "discard";        <value> $discard-counter;      }    }  }}template convert-hex2dec($hex) {  /* 0x00000000 is the only hex len supported */  var $split = jcs:regex("0x([0-9a-zA-Z]{1})([0-9a-zA-Z]{1})([0-9a-zA-Z]{1})([0-9a-zA-Z]{1})([0-9a-zA-Z]{1})([0-9a-zA-Z]{1})([0-9a-zA-Z]{1})([0-9a-zA-Z]{1})",$hex);  var $val0 = {    call convert-char2int() {      with $char = $split[2];    }  }  var $val1 = {    call convert-char2int() {      with $char = $split[3];    }  }  var $val2 = {    call convert-char2int() {      with $char = $split[4];    }  }  var $val3 = {    call convert-char2int() {      with $char = $split[5];    }  }  var $val4 = {    call convert-char2int() {      with $char = $split[6];    }  }  var $val5 = {    call convert-char2int() {      with $char = $split[7];    }  }  var $val6 = {    call convert-char2int() {      with $char = $split[8];    }  }  var $val7 = {    call convert-char2int() {      with $char = $split[9];    }  }  var $dec-val = ($val0 * 268435456) + ($val1 * 16777216) + ($val2 * 1048576) + ($val3 * 65536) + ($val4 * 4096) + ($val5 * 256) + ($val6 * 16) + ($val7 * 1);  <result> $dec-val;}template convert-char2int($char) {  if ($char = "a") {    <result> 10;  } else if ($char = "b") {    <result> 11;  } else if ($char = "c") {    <result> 12;  } else if ($char = "d") {    <result> 13;  } else if ($char = "e") {    <result> 14;  } else if ($char = "f") {    <result> 15;  } else {    <result> $char;  }}template set-utility-mib($type,$mib-name, $value) {  /* string limited to 947 chars */  var $rpc = <request-snmp-utility-mib-set> {    <object-type> $type;        <instance> $mib-name;    <object-value> $value;  }  call jcs:execute($connection,$rpc);}template clear-utility-mib($type,$mib-name) {  var $rpc = <request-snmp-utility-mib-clear> {    <object-type> $type;        <instance> $mib-name;  }  call jcs:execute($connection,$rpc);}template write-to-file($npstats,$xmstats) {  <op-script-results> {    <xsl:document href="/var/tmp/output-file" append="yes" method="text"> {      <total-np-stats> {        copy-of $npstats;      }    }  }}match / {  if (not($connection)) {    call emit-error($message = "Not able to connect to local device");  }  var $npstats = {    call get-ioc-info();  }  var $xmstats = {    call get-spc-info();  }  var $spustats = {    call get-spu-info();  }  <op-script-results> {    <xsl:document href="/var/tmp/mburst-stats" append="no" method="xml"> {      <stats> {        <np-stats> {          copy-of $npstats;        }        <xm-stats> {          copy-of $xmstats;        }        <spu-stats> {          copy-of $spustats;        }      }    }  }}